name: NX release

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "packages/**"
      - "configs/**"

permissions:
  actions: write
  contents: write
  pull-requests: write
  issues: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  push:
    name: ðŸ”– Release packages
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ¦– Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - name: ðŸ”» Checkout repo
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸƒ Run Node and NPM setup
        uses: ./.github/actions/setup-project

      - name: ðŸ’¬ Sets the base and head SHAs for the nx affected commands in CI
        uses: nrwl/nx-set-shas@v4

      - name: ðŸ”„ Build affected libs
        run: npx nx affected -t build

      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          # Get affected projects
          AFFECTED=$(npx nx show projects --affected --type=lib)
          echo "affected=$AFFECTED" >> $GITHUB_OUTPUT

          # Check if any projects are affected
          if [ -n "$AFFECTED" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Found affected projects: $AFFECTED"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No affected projects found"
          fi

      - name: ðŸ”– Generate version and changelog (dry-run)
        if: steps.check_changes.outputs.has_changes == 'true'
        id: version_check
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Run nx release in dry-run mode to get version info
          npx nx release --dry-run --skip-publish > release_output.txt 2>&1 || true

          # Check if there are any version changes
          if grep -q "New version.*written to manifest" release_output.txt; then
            echo "has_versions=true" >> $GITHUB_OUTPUT
            echo "Version changes detected"
            cat release_output.txt
          else
            echo "has_versions=false" >> $GITHUB_OUTPUT
            echo "No version changes detected"
          fi

      - name: ðŸ”– Create release branch and PR
        if: steps.version_check.outputs.has_versions == 'true'
        id: create_release
        env:
          GH_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Create a unique branch name
          BRANCH_NAME="release/automated-$(date +%s)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Create and switch to release branch
          git checkout -b "$BRANCH_NAME"

          # Run nx release to generate versions and changelogs
          npx nx release --skip-publish

          # Push the release branch
          git push origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "ðŸ”– Automated Release" \
            --body "This PR contains automated version bumps and changelog updates generated by nx release." \
            --base main \
            --head "$BRANCH_NAME" \
            --label "release" \
            --reviewer "@me"

          echo "Release PR created for branch: $BRANCH_NAME"

      - name: ðŸ“ Comment on triggering commit
        if: steps.version_check.outputs.has_versions == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the current commit SHA
          COMMIT_SHA="${{ github.sha }}"

          # Create a comment on the commit
          gh api repos/${{ github.repository }}/commits/$COMMIT_SHA/comments \
            --method POST \
            --field body="ðŸ”– **Automated Release Generated**

This commit triggered automated version updates. A release PR has been created: ${{ steps.create_release.outputs.branch_name }}

The following packages will be updated:
- Check the release PR for detailed changelog and version changes

Once the PR is merged, packages will be automatically published to NPM."

      - name: ðŸ“Š Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Affected projects detected" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.version_check.outputs.has_versions }}" == "true" ]; then
              echo "âœ… Version changes generated" >> $GITHUB_STEP_SUMMARY
              echo "âœ… Release PR created: ${{ steps.create_release.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸ No version changes needed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ No affected projects found" >> $GITHUB_STEP_SUMMARY
          fi
